---
title: "Компьютерная работа №1"
author: "Команда студентов БСТ182 (Джумаева, Золотарев, Кабанова, Морина, Тислюк, Хисяметдинова)"
date: "01 11 2020"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
---


```{r}
#используем только если надо установить пакеты в cамом начале
#install.packages('DescTools')
#install.packages('EnvStats')
#install.packages('outliers')
#install.packages("ggpubr")
#install.packages("Hmisc")
#install.packages('corrplot')
#install.packages('ppcor')
#install.packages('rio')
#install.packages('robustHD')
#install.packages('ggplot2')
#install.packages('lmtest')
#install.packages('sjPlot')
#install.packages('normtest')
#install.packages('GGally')
#install.packages('leaps')
#install.packages('R6')
```

```{r}
library(DescTools)
library(EnvStats)
library(outliers)
library(ggplot2)
library(ggpubr)
library(Hmisc)
library(corrplot)
library(ppcor)
library(rio)
library(robustHD)
library(lmtest)
library(normtest)
library(GGally)
library(leaps)
library(tidyr)
library(sjPlot)
```


# Многомерные статистические методы

## Компьютерная работа №1. 

## Постановка задачи

ВВП на душу населения является одним из ключевых показателей при определении уровня жизни в стране. Однако на этот фактор влияют и другие переменные. В проведенном нами исследовании было выбрано 17 показателя, которые предположительно играют важную роль при оценке качества жизни в стране.

Описание переменных:
1) 142 страны мира, по которым было возможно собрать остальные 17 переменных в 2018 году. Остальные ~80 стран было необходимо убрать ввиду излишнего большого количества пропущенных данных.

2, 4) Экспорт и импорт товаров и услуг (в % от ВВП).

Экспорт и импорт товаров и услуг представляет собой стоимость всех конечных товаров и других рыночных услуг, поставленных остальным странам мира. Они включают стоимость товаров, грузов, страхования, транспорта, путешествий, лицензионных платежей и других услуг, таких как связь, строительство, финансовые, информационные, деловые, личные и государственные услуги. Они исключают компенсацию работникам и инвестиционный доход, а также трансфертные платежи.
В данном исследовании этот показатель имеет место быть с целью продемонстировать, что международная торговля повышает уровень жизни в государстве, так как приносит дополнительный доход.

**Источник:** World Bank national accounts data, and OECD National Accounts data files.

3) Расходы на конечное потребление (в % от ВВП).

Расходы на конечное потребление - это сумма расходов на конечное потребление домашних хозяйств и расходов на конечное потребление государства.
В нашем предположении, чем выше расходы, тем выше уровень жизни в государства, так как конечное потребление входит в ВВП по расходам, что стимулирует экономику к росту.

**Источник:** World Bank national accounts data, and OECD National Accounts data files.

5) Валовые сбережния домохозяйств (в % от ВВП)

Валовые внутренние сбережения рассчитываются как ВВП за вычетом расходов на конечное потребление (общее потребление).
Сбережения являются одним из ключевых показателей уровня жизни, так показывают средства домохозяйств, которые те могут откладывать. А это значит, что домохозяйство имеют финансовую "подушку" в виде нерасходованных средств.

**Источник:** World Bank national accounts data, and OECD National Accounts data files.

6) Расходы государства (в % от ВВП)

Валовые национальные расходы представляют собой сумму расходов на конечное потребление домашних хозяйств, расходов на конечное потребление органов государственного управления и валового накопления капитала.
Данный показатель может положительно влиять на уровень жизни в государстве, так как показывает сумму средств, затрачиваемых гражданами страны.

**Источник:** World Bank national accounts data, and OECD National Accounts data files.

7) Коэффициент участия в рабочей силе в возрасте 15-24 лет

Коэффициент участия в рабочей силе в возрасте 15-24 лет - это доля экономически активного населения в возрасте 15-24 лет: все люди, поставляющие рабочую силу для производства товаров и услуг в течение определенного периода времени.
Экономическая вовлеченность потенциально необразованного населения является интересным показателем, который демонстрирует, что граждане, которые потенциально должны заниматься образованием, вынуждены (или хотят) работать.

**Источник:** International Labour Organization, ILOSTAT database

8-9) Занятость в секторе услуг и индустрии (% от рабочей силы государства)

Общеизвестно, что в условиях современного развития мира человечество стремится к минимизации ручного труда в производстве, создавая возможности для трудоустройства в менее физически сложных профессиях. Эти показатели отражают процесс перехода государства к новой модели мира, в рамках которой физический труд всё больше и больше отходит на второй план.

**Источник:** International Labour Organization, ILOSTAT database

10) Смертность среди детей до 5 лет (на 1000 рождённых)

Коэффициент смертности детей в возрасте до пяти лет-это вероятность на 1000 человек, что новорожденный ребенок умрет до достижения пятилетнего возраста, если учитывать возрастные коэффициенты смертности указанного года.
Смертность до 5 лет хорошо отражает уровень развития медицины (как инфраструктуры, так и квалификации ответственных лиц) в стране.

**Источник:** Estimates developed by the UN Inter-agency Group for Child Mortality Estimation (UNICEF, WHO, World Bank, UN DESA Population Division) at www.childmortality.org.

11-12) Население крупнейшего города и городов-миллионников (в % от городского населения страны).

Население крупнейшего города-это процент городского населения страны, проживающего в крупнейшем мегаполисе этой страны.
Этот показатель демонстрирует обратную зависимость с равномерностью развития городов в государстве, влияющего на уровень жизни в провинциях и желании развивать человеческий капитал в миноритарных регионах.

**Источник:** United Nations, World Urbanization Prospects

13) Коэффициент вовлеченности в профессиональное образование.

Валовой коэффициент вовлеченности-это отношение общего числа учащихся, независимо от возраста, к населению той возрастной группы, которая официально соответствует показанному уровню образования. Высшее образование, независимо от того, соответствует ли оно высшей исследовательской квалификации или нет, обычно требует в качестве минимального условия поступления и успешного завершения образования на среднем уровне.
Данный показатель был взят с целью показать, что профессиональное образование положительно влияет на уровень жизни в стране, так как повышает степень экономической вовлеченности граждан и количество квалифицированных рабочих кадров.

**Источник:** UNESCO Institute for Statistic

14) Общий уровень безработицы.

Безработица относится к доле рабочей силы, которая не имеет работы, но находится в ее поисках.

**Источник:** International Labour Organization, ILOSTAT database.

15) Городское население (% от общего населения)

Городское население относится к людям, живущим в городских районах, как это определено национальными статистическими управлениями. Эти данные собираются и сглаживаются отделом народонаселения Организации Объединенных Наций.
Резкий рост городов во всем мире означает демографический переход от сельских районов к городским и связан с переходом от экономики, основанной на сельском хозяйстве, к массовой промышленности, технологиям и услугам. В принципе, города предлагают более благоприятные условия для решения социальных и экологических проблем, чем сельские районы. Города создают рабочие места, а также предоставляют образование, здравоохранение и другие услуги. Города также предоставляют возможности для социальной мобилизации и расширения прав и возможностей женщин.

**Источник:** United Nations Population Division. World Urbanization Prospects: 2018 Revision.

**Следующие 3 показателя являются показателями ВВП страны, непосредственно относящимися к целевой переменной нашего исследования.**

16) ВВП, ППС (в $ USA).

Этот показатель обеспечивает значения валового внутреннего продукта (ВВП), выраженные в текущих международных долларах, пересчитанных по коэффициенту пересчета паритета покупательной способности (ППС). ВВП - это сумма валовой добавленной стоимости всех производителей-резидентов страны плюс любые налоги на продукцию и минус любые субсидии, не включенные в стоимость продукции. Коэффициент пересчета ППС-это пространственный дефлятор цен и конвертер валют, который устраняет последствия различий в уровнях цен между странами.

**Источник:** World Bank national accounts data, and OECD National Accounts data files.

17) Темп роста ВВП. (ежегодный в %)

Годовой процентный темп роста ВВП в рыночных ценах на основе постоянной местной валюты. Агрегированные показатели основаны на постоянных долларах США за 2010 год. ВВП - это сумма валовой добавленной стоимости всех производителей-резидентов в экономике плюс любые налоги на продукцию и минус любые субсидии, не включенные в стоимость продукции. Она рассчитывается без учета отчислений на амортизацию производственных активов или на истощение и деградацию природных ресурсов.

**Источник:** World Bank national accounts data, and OECD National Accounts data files.

**ЦЕЛЕВАЯ ПЕРЕМЕННАЯ**

18) ВВП на душу населения.

Данный показатель представляет собой ВВП, поделенный на численность населения в данном году.

**Источник:** World Bank national accounts data, and OECD National Accounts data files.

Таким образом, **гипотезой** нашего исследования является предположение о том, что показатели 2-15 положительно влияют на ВВП на душу населения.

**Объект исследования:** динамика уровня жизни в различных странах.

**Предмет исследования:** данные по приведенным выше показателям. Следует отметить, что почти все выбранные переменные приведены в относительных значениях, являясь долей либо от той или иной группы населения, либо от непосредственно самого ВВП. Очевидно, это несколько исказит наши результаты, но идея такого решения заключается в том, что таким образом мы приводим признаки в процентную шкалу, благодаря которой мы заочно избавляемся от существенных выбросов из данных, и можем проследить паттерны моделей расходования располагаемого ВВП государства (возможно, богатые государства тратят в процентном соотношении больше, чем сберегают ввиду уверенности в заработке завтрашнего дня).

Импортируем данные: имеем 142 наблюдения и 18 переменных.
```{r}
data <- read.csv('GDP Analysis.csv', sep = ';')
```

Перед нами стоит задача по имеющейся выборке предсказать показатель ВВП на лушу населения, обозначенный переменной `GDP.per.capita....`, в зависимости от таких объективных факторов:

Обозначение переменной | Переменная
------------- | -------------
Export | Экспорт товаров и услуг (в % от ВВП)
Consumption | Расходы на конечное потребление (в % от ВВП)
Savings | Валовые сбережния домохозяйств (в % от ВВП)
National.Expenditure | Государственные расходы
Import | Импорт товаров и услуг (в % от ВВП)
Labor.among.youth | Коэффициент участия в рабочей силе в возрасте 15-24 лет (%)
Emploument.in.services | Доля занятых в сфере услуг (%)
Employment.in.industry | Доля занятых в промышленном секторе (%)
Mortality.rate.under.5 | Смертность до 5 лет
Population..largest.city. | Население крупнейшего города (в % от городского населения страны)
University.enrollment | Коэффициент вовлеченности в профессиональное образование
Unemployment | Общий уровень безработицы (%)
Urban.population | Городское население (% от общего населения)
GDP.by.PPP.... | ВВП, ППС (в $ USA)
GDP.qrowth | Темп роста ВВП (ежегодный в %)


## Основные характеристики случайных величин

Изучим значения наших целевых переменных подробнее, воспользовавшись функциями Desc() и summaryStats():
```{r}
Desc(data)
```
Проанализируем те признаки, которые будем использовать далее в качестве объясняющей переменной:
```{r}
data_cont <- data[, c('Export', 'Consumption', 'Savings', 'National.Expanditure', 'Labor.among.youth', 'Employment.in.services', 'Employment.in.industry', 'Mortality.rate.under.5', 'Population..largest.city.', 'University.enrollment', 'Unemployment', 'Urban.population', 'GDP.per.capita....')]
summaryStats(data_cont)
```
После произведения всех расчетов характеристик случайных величин, можно заметить, что все переменные (за исключением доли сбережений от ВВП) строго положительные, что абсолютно логично, исходя из выбранных нашей группой показателей.

Такие показатели как сбережения, чистые расходы, занятость в промышленном секторе и доля поступивших в высшее учебное заведение c большей долей вероятности имеют нормальное распределение, так как медиана и среднее имеют практически одинаковые значения, а также их сгрупированные по методу квадратного корня наблюдения визуально напоминают именно распределение Гаусса.

Данные по 13/17 показателей являются неоднородными(показатель вариации превышает 0,33), наиболее однородными следует считать данные по показателям потребления(0,19) и чистых расходов(0,144). Наиболее неоднородные данные представлены по ВВП по ППС, смертности и ВВП на душу населения.

Также обращается на себя не сгруппированность данных около средней по уровню экспорта, импорта, смертности и ВВП по ППС(закономерно, так как высокий разброс по ВВП приводит к разбросу в уровне жизни, социального обеспечения, зарплат, а, следовательно, и смертности), обучения в ВУЗ, городского населения: об этом говорит высокий показатель дисперсии и размаха вариации.

Можно составить портрет среднестатистической страны, участвующей в исследовании: уровень экспорта - 44,27% от ВВП, импорта - 47,66% от ВВП, потребление - 78,71% от ВВП, безработица - 6,65%, ВВП на душу населения - 16409 долларов в год, чистые расходы - 100,97% от ВВП, занятость подростков в возрасте 17-24 лет - 43,65% от общей возрастной группы, население в городах-миллионниках - 29,89% от общего населения, занятость в промышленном секторе - 20,15% от рабочей силы, смертность среди детей младше 5 лет - 27,9 смертей на 1000 рождений.

Самый высокий показатель межквартильного диапазона представлен у следующих признаков: доля поступивших в высшее учебное заведение, смертность, городское население и ВВП на душу населения, что свидетельствует о меньшем количестве возможных выбросов в выборке.

Теперь постараемся более тщательно изучить нашу целевую переменную - показатель ВВП на душу населения:
```{r}
GDP_per_capita <- log(data$GDP.per.capita....)
Desc(GDP_per_capita)
```

За исключением 10 наиболее успешных стран мира по данному фактору, распределение напоминает логнормальное с выраженной левосторонней асимметрией и плосковершинностью. Ранговые характеристики здесь могут послужить индикатором богатства или бедности стран, однако стоит учитывать тот момент, что мы не учитываем в выборке около 100 стран мира и берём не взвешенные на долю населения в стране характеристики. Поэтому на основе этих данных будет ошибочно утверждать о том или ином уровне дохода на душу населения по всей Земле ввиду необходимости брать именно взвешенные значения по странам. Однако крайне удручает тот факт, что 25% изучаемых стран находятся на пороге бедности, поскольку в пересчёте в рубли средний уровень разделённого богатства государства там находится на уровне 12000 рублей в месяц на человека. 
Вероятнее всего, нам придётся избавиться от выбросов и применить линейные преобразования для того, чтобы получить наиболее близкое к нормальному распределение и абсолютно правоправно проводить корреляционный и регресионный анализ, базирующийся на предпосылках о нормальности распределения. Иначе связи были бы нелинейны и применение метода наименьших квадратов было бы невозможно. Перейдём к дальнейшему изучению нашего набора данных.


## Диагностика выбросов

В предыдущем пункте был рассчитан IQR, где можно было заметить, что разброс ВВП на душу населения по методу IQR составляет 21 423 доллара в год, что является крайне большой разницей, свидетельствующей о достаточном сильном неравенстве благополучия между странами, что в принципе и так ожидаемо. Посчитаем относительный показатель квартильной вариации для нашей целевой переменной:

```{r}
IQR(GDP_per_capita)/2/median(GDP_per_capita)
```
Данное значение в несколько раз превышает граничное значение, при котором мы могли бы назвать наши данные однородными, что в очередной раз свидетельствует о весомой разнице между ВВП на душу населения между странами мира.

Перейдём к анализу выбросов и аномалий для нашей целевой переменной. Проверим их наличие или отсутствие тремя методами:

1. Правило $3\sigma$:

```{r}
lower_mu = mean(GDP_per_capita) - 3*sd(GDP_per_capita)
upper_mu = mean(GDP_per_capita) + 3*sd(GDP_per_capita)
low_outliers = which(GDP_per_capita < lower_mu)
high_outliers = which(GDP_per_capita > upper_mu)
```
```{r}
cat(c('Выбросы из правила 3 сигм относительно нижней границы доверительного интервала:', low_outliers))
```
Ожидаемо, здесь не оказалось выбросов по той причине, что медиана гораздо меньше среднего и все ранговые характеристики ниже медианы сосредоточены не так далеко друг от друга, как это происходит среди ранговых характеристик выше медианы.

```{r}
cat(c('Выбросы из правила 3 сигм относительно верхней границы доверительного интервала:', high_outliers))
```
Взглянув на данные, мы видим, что на 3 и 138 строчках расположились Люксмебург и Швейцария, которые в нашем случае являются выбросами и, вероятнее всего, в дальнейшем будут исключены из исследования. Высокий уровень ВВП на душу населения в данных странах может быть объяснён высоким уровнем концентрации финансовых капиталов в данных странах, наиболее стабильные и совершенные по своей структуре банки расположены именно в этих странах.

Также определим, какие наблюдения будут признаны выбросами по правилам 1.5IQR & 3IQR:

```{r}
out_of_1.5IQR <- boxplot.stats(GDP_per_capita)$out 
out_of_1.5IQR_ind <- which(GDP_per_capita %in% out_of_1.5IQR)
out_of_1.5IQR_ind
```
В качестве верхних выборосов здесь добавляются такие страны, как Ирландия, Исландия, Австралия, США, Норвегия, Катар, Сингапур и Дания. Каждая из этих стран оказалась в столь благополучном положении в силу самых разных причин, начиная от выгодного географического положения и закачнивая грамотной политикой управления государством на протяжении нескольких десятилетий, создающую благополучную почву для экономической деятельности внутри страны.

```{r}
out_of_3IQR <- boxplot.stats(GDP_per_capita, coef = 3)$out 
out_of_3IQR_ind <- which(GDP_per_capita %in% out_of_3IQR)
out_of_3IQR_ind
```
По правилу 3IQR мы получаем всего один выброс в виде Люксмебурга, чего явно будет недостаточно для приведения ряда данных к нормальному виду. Вероятнее всего, лучше сгладит разницу между медианой и средним применение правила 1.5IQR, которое укоротит нашу выборку на 10 наблюдений, проверим новые полученные значения среднего и медианы:

```{r}
clearData <- data_cont[-out_of_1.5IQR_ind, ]
median(clearData$GDP.per.capita....)
mean(clearData$GDP.per.capita....)
```
Видно, что разница уменьшилась с более чем 10000 долларов на душу населения до примерно 6500, что является весьма положительным индикатором проведённого анализа выбросов.

Теперь построим ящичковые диаграммы для наших данных, сравним графики до и после удаления выбросов:
```{r}
boxplot(GDP_per_capita, col = 'pink') # ящичковая диаграмма для ВВП на душу населения с выбросами
boxplot(clearData$GDP.per.capita...., col = 'pink') # ящичковая диаграмма для ВВП на душу населения без выбросов
```

Видим, что после удаления выбросов у нас образовались новые относительно новых квартилей данных, которые, возможно, также следовало бы последовательно убирать вплоть до момента, когда у нас больше не будет выбросов значений относительно предполагаемого максимума.

Стандартизуем очищенные от выбросов в целевой переменной данные и проверим, какие выбросы существуют в других переменных. Заранее оговорим, что мы не будем убирать наблюдения со значительными выбросами среди объясняющих переменных, поскольку это хоть и влияет на предсказательную силу этих переменных, но чересчур сильно сожмёт нашу выборку, что также негативно повлияет на качество модели.

```{r}
rdata <- clearData
```

```{r}
rdata$Export <- robStandardize(clearData$Export)
rdata$Consumption <- robStandardize(clearData$Consumption)
rdata$Savings <- robStandardize(clearData$Savings)
rdata$National.Expanditure <- robStandardize(clearData$National.Expanditure)
rdata$Labor.among.youth <- robStandardize(clearData$Labor.among.youth)
rdata$Employment.in.services <- robStandardize(clearData$Employment.in.services)
rdata$Employment.in.industry <- robStandardize(clearData$Employment.in.industry)
rdata$Mortality.rate.under.5 <- robStandardize(clearData$Mortality.rate.under.5)
rdata$Population..largest.city. <- robStandardize(clearData$Population..largest.city.)
rdata$University.enrollment <- robStandardize(clearData$University.enrollment)
rdata$Unemployment <- robStandardize(clearData$Unemployment)
rdata$Urban.population <- robStandardize(clearData$Urban.population)
rdata$GDP.per.capita.... <- robStandardize(clearData$GDP.per.capita....)
boxplot(rdata, varwidth = TRUE, col = "bisque", main="Ящичковая диаграмма для объясняющих и целевой переменных")
```

Видим, что в показателе ВВП на душу населения всё ещё достаточно много выбросов, особенно после стандартизации.

Воспользуемся тестом Граббса для проверки $H_0$, предполагающей, что максимальное или минимальное наблюдение в выборке является типичным наблюдением.

```{r}
GDP_per_capita <- clearData$GDP.per.capita....
# проверяется максимальное наблюдение
grubbs.test(GDP_per_capita)
```

```{r}
#проверяется минимальное наблюдение
grubbs.test(GDP_per_capita, opposite = TRUE)
```
Так, на любом адекватном уровне значимости гипотеза о наличии выбросов в данных отвергается с вероятностью ошибки первого рода $\alpha$.

Проведём также тест Рознера, чтобы проверить больше одного крайнего наблюдения, чтобы усилить уверенность в наших предпосылках. 
$H_0:$ $k$ наибольших наблюдений взяты из той же генеральной совокупности, что и $(n-k)$ первых наблюдений:
```{r}
# тест Рознера
rosnerTest(GDP_per_capita, k = 10)
```
По его результатам в наших данных также не отвергается гипотеза об отсутствии выбросов в данных. Таким образом мы можем сделать вывод, что, применив правило 1.5IQR, мы избавились от выбросов и можем идти дальше. Это очень важно для возможности дальнейшего анализа.

Отлично! Перейдём к следующему этапу - проверке распределения целевой переменной на нормальность.

## Проверка соответствия эмпирического распределения нормальному распределению

Характеристики формы распределений непрерывных переменных:
```{r}
print("Коэффициенты асимметрии для непрерывных переменных составляют...")
apply(data_cont, 2, Skew) #асимметрия
print("Коэффициенты эксцесса для непрерывных переменных составляют...")
apply(data_cont, 2, Kurt) #эксцесс
```
Касаемо асимметрии, у всех признаков наблюдается правосторонняя асимметрия, за исключением сбережений, занятости в сфере услуг, городского населения и роста ВВП. Также хочется подметить, что у всех признаков показатель асимметрии значителен, кроме доли поступивших в высшие учебные заведения.

Коэффициент эксцесса показывает отрицательные значения у показателей городского населения, занятость подростков в возрасте 17-24 лет, занятости в сфере услуг, что говорит об их островершинном распределении. В свою очередь, крайне выделяется на фоне остальных значений плосковершинность экспорта, свидетельствующий о почти равномерном распределении этого значения среди остальных показателей. 

Мы уже строили гистограммы и с их помощью интерпретировали объясняющие переменные на начальных этапах работы, поэтому ограничимся здесь лишь приведением логарифма гистограммы целевой переменной, поскольку это линейное преобразование поможет нам нормализовать данные:
```{r}
hist(GDP_per_capita, breaks = 'Sturges', freq = FALSE, col = 'pink')
hist(log(GDP_per_capita), breaks = 'Sturges', freq = FALSE, col = 'pink')
```

Действительно, после линейного преобразования при группировке наблюдений по методу Стёрджеса мы получаем нечто хотя бы отдалённо напоминающее график нормального распределения. Попытаемся визуализировать с помощью других типов графиков:

stemplot

```{r}
stem(GDP_per_capita)
```
```{r}
ggplot(clearData, aes(x = round(GDP_per_capita/1000, 0))) + geom_dotplot(binwidth = 1.5, stackdir = "center")
```

Построив стеблевую и точечные диаграммы, мы вновь можем убедиться в том, что без логарифмирования наши данные имеют крайне смещённую в сторону низких значений структуру. Попробуем ещё раз изучить влияние данного линейного преобразования на примере этих двух графиков:

```{r}
stem(log(GDP_per_capita))
ggplot(clearData, aes(x = log(GDP_per_capita))) + geom_dotplot(stackdir = "center")
```

Из визуализации кажется, что после линейного преобразования у нас получается почти равномерное распределение, несколько смещённое вправо. Посмотрим, возможно ли будет принять его в качестве нормального распределения, проверив соответствующие гипотезы.

Для проверки соответствия эмпирических распределений некоторым теоретическим используются критерии согласия. Для того, чтобы было возможно применить все последующие многомерные статистические методы, нам необходимо проверить гипотезу о нормальности распределения целевой переменной:

\[
H_0 : \text{ выборка для целевой переменной взята из генеральной совокупности с нормальным распределением }
\]

Применим сначала наиболее простой критерий согласия - критерий Пирсона:
```{r}
PearsonTest(log(GDP_per_capita))
# тест Пирсона
```

Традиционный метод дал крайне высокое значение p-value, не совсем соответствующее увиденному на графиках даже после линейных преобразований. Поэтому попробуем применить наиболее мощные критерии - Шапиро-Уилка и Жарке-Бера, не отвергнув которые можно будет смело использовать гипотезу о нормальности распределения при дальнейшем анализе:
```{r}
shapiro.test(log(GDP_per_capita))
JarqueBeraTest(log(clearData$GDP.per.capita....), robust = FALSE)
ks.test(log(GDP_per_capita), rnorm(132, mean = mean(log(GDP_per_capita)), sd = sd(log(GDP_per_capita))))
# тест Шапиро-Уилка
```
Видим, что наиболее мощные тест дают несколько разные результаты при проверке целевой переменной на нормальность, но в целом на уровне значимости 0.05, который принято считать наибольшим адекватным значением ошибки первого рода, 3/4 гипотез не отвергаются, за исключением той, которая имеет наибольшую мощность и по этой же причине отвергается достаточно часто. Поэтому мы можем принять решение о нормальности полученных через логарифмирование ВВП на душу населения данных, будем использовать их далее для корреляционного и регресионного анализа.
```{r}
clearData$GDP.per.capita.... <- log(GDP_per_capita)
```

## Корелляционный анализ

Построим матрицу парных коэффициентов корреляции на **исходных данных (до удаления выбросов)**.
```{r}
cor_m_Outliers <- rcorr(as.matrix(data_cont), type = "pearson")
cor_m_Outliers
```

Теперь нам удобнее выбрать переменные, чтобы построить облака корреляции для исследования взаимосвязи между переменными. Покажем по 3 случая (положительной, обратной зависимости и ее отсутствия) между исследуемыми переменными.

Сначала проделаем это с **исходными данными (т.е. до удаления выбросов)**.
```{r}
ggscatter(data_cont, x = "Employment.in.services", y = "GDP.per.capita....",
          xlab = "Доля занятых в сфере услуг", ylab = "ВВП на душу наседения",
          color = "pink", cor.coef = TRUE, add = "reg.line", conf.int = TRUE)
```

Как видно из диаграмы, в целом ВВП на душу населения имеет положительную и среднюю по силе (0,67) взаимосвязь с долей занятых в сфере услуг. 

Следующее поле корреляции отражает отрицательную взаимосвязь переменных:
```{r}
ggscatter(data_cont, x = "Mortality.rate.under.5", y = "GDP.per.capita....",
          xlab = "Уровень смертности детей до 5 лет", ylab = "ВВП на душу наседения",
          color = "blue", cor.coef = TRUE, add = "reg.line", conf.int = TRUE)
```

Теперь визуализируем отсутствие взаимосвязи между переменными:
```{r}
ggscatter(data_cont, x = "Population..largest.city.", y = "GDP.per.capita....",
          xlab = "Доля населения крупнейшего города от всего населения страны", ylab = "ВВП на душу наседения",
          color = "yellow", cor.coef = TRUE, add = "reg.line", conf.int = TRUE)
```

Теперь проведем аналогичные действия с данными **после удаления аномальных наблюдений.**

Для определения степени линейной зависимости между переменными, рассмотрим матрицу парных коэффициентов корреляции.
```{r}
cor_m_main <- rcorr(as.matrix(clearData), type = "pearson")
cor_m_main
```
Очень важным моментом в преддверии следующей главы нашей работы, регрессионным анализом, является избавление набора данных от функционально зависимых между собой переменных. Эти избыточные переменные могут значительно увеличить стандартные ошибки коэффициентов регрессии и испортить предсказательную силу модели, поэтому мы уберём факторы "Savings" & "National Expanditure" ввиду их взаимозаменяемости с переменной потребления, также мы убрали из всех расчётов показатели, оговорённые в начале нашей работы: импорт и долю населения в городах-миллионниках ввиду их сильной взаимозависимости с экспортом и долей населения в самых больших городах соответственно.

```{r}
drop <- c("National.Expanditure", "Savings")
clearData <- clearData[ , !(names(clearData) %in% drop)]
```

Объем экспорта, потребление и сбережения, имеют умеренную связь с ВВП на душу населения,а также, в целом, незначительные величины коэффициента парной корреляции. На данных подтверждается функциональная зависимость сбережений и потребления. Данные показывают обратную среднюю корреляцию государственных расходов и ВВП на душу населения, хотя при расчете ВВП они идут со знаком плюс и в выборке нет отрицательных значений госрасходов. К другим отрицательно воздействующим на ВВП на д.н. показателям относятня труд среди молодежи и смертность. 
Высокая степень связи прослеживается между ВВП на д.н. и такими показателями, как занятость в сфере услуг, зачисления в вузы и численность городского населения. Стоит заметить, что между каждыми двумя из трех перечисленных переменных также имеет место тесная связь.
Крайне слабая зависимость связывает ВВП и безработицу, но удивительно то, что она прямая. То есть, "Закон Оукена" не работает на наших данных.

Теперь взаимосвязь доли занятых в сфере услуг и ВВП на душу населения более сконцентрирована, коэффициент корреляции увеличился до 0,85 после удаления выбросов. Данная пара переменных демонстрирует сильнейшую взаимосвязь среди всех исследуемых факторов.

```{r}
ggscatter(clearData, x = "Employment.in.services", y = "GDP.per.capita....",
          xlab = "Доля занятых в сфере услуг", ylab = "ВВП на душу наседения",
          color = "pink", cor.coef = TRUE, add = "reg.line", conf.int = TRUE)
```

Сильнейшая отрицательная взаимосвязь после удаления выбросов также усилилась.
```{r}
ggscatter(clearData, x = "Mortality.rate.under.5", y = "GDP.per.capita....",
          xlab = "Уровень смертности детей до 5 лет", ylab = "ВВП на душу наседения",
          color = "blue", cor.coef = TRUE, add = "reg.line", conf.int = TRUE)
```

Наконец, отсутствие (почти отсутствие :)) взаимосвязи выглядит более очевидным.
```{r}
ggscatter(clearData, x = "Population..largest.city.", y = "GDP.per.capita....",
          xlab = "Численность населения крупнейшего города", ylab = "ВВП на душу наседения",
          color = "yellow", cor.coef = TRUE, add = "reg.line", conf.int = TRUE)
```

Визуализация результатов корреляционного анализа и корреляционной матрицы с учетом уровня значимости: 
-данные до удаления выбросов:

```{r}
corrplot.mixed(cor(data_cont), lower.col = 'blue', upper = 'pie')
```
```{r}
res <- cor.mtest(data_cont, conf.level = 0.95)
corrplot(cor(data_cont), p.mat = res$p, sig.level = 0.05)
```

-данные после удаления выбросов:

```{r}
corrplot.mixed(cor(clearData), lower.col = 'blue', upper = 'pie')
```
```{r}
res1 <- cor.mtest(clearData, conf.level = 0.95)
corrplot(cor(clearData), p.mat = res1$p, sig.level = 0.05)
```


Для заданного уровня значимости 0,05 коэффициенты корреляции между безработицей, населением самого большого города и ВВП на д.н. соответсвенно не значимы, то есть изучать линейную зависимость между безработицей, численностью крупнейшего города и ВВП на д.н. нельзя. 


Займёмся построением доверительных интервалов для тех коэффициентов корреляции, которые мы приняли значимо отличными от нуля:
```{r}
xor(cor.mtest(clearData, method = "pearson", conf.level = 0.95)$lowCI>0, cor.mtest(clearData, method = "pearson", conf.level = 0.95)$uppCI<0)

```
Исходя из доверительных интервалов, значимо отличны от 0 следующие коэффициенты корреляции (с учётом симметричности учитываем только новые пары значений на каждой новой строчке):
1 строчка - 2, 4, 5, 6, 7, 8, 10, 11 столбцы
2 строчка - 4, 5, 6, 8, 10, 11 столбцы
3 строчка - 4, 5, 6, 8, 9, 10, 11 столбцы
4 строчка - 5, 6, 8, 9, 10, 11 столбцы
5 строчка - 6, 8, 9, 10, 11 столбцы
6 строчка - 8, 10, 11 столбцы
7 строчка - ни одной новой связи
8 строчка - 10, 11 столбцы
9 строчка - 10 столбец
10 строчка - 11 столбец
11 строчка - ни одной новой связи

Представим значимо отличные от нуля границы доверительных интервалов для парных коэффициентов корреляций, ниже представлена нижняя граница доверительного интервала:
```{r}
p_cor_mat <- cor.mtest(clearData, method = "pearson", conf.level = 0.95)$p
ifelse(p_cor_mat<0.05, round(cor.mtest(clearData, method = "pearson", conf.level = 0.95)$lowCI, 3), 'NULL')
```
Верхняя граница доверительного интервала
```{r}
ifelse(p_cor_mat<0.05, round(cor.mtest(clearData, method = "pearson", conf.level = 0.95)$uppCI, 3), 'NULL')
```

**Добавить сюда интерператцию, сказать про то, что мы можем с вероятностью ошибки первого рода 0.05 установить направления характера связи между переменными.**

Для измерения связи между объясняющими переменными и ВВП на душу населения при устранении воздействия прочих факторов модели, расчитаем частный коэффициент корреляции:
```{r}
cor_p <- pcor(clearData) #частные коэффициенты корреляции
round(cor_p$estimate, 3)
```
Рассчитаем значимость полученных значений по прицнипу p-value:
```{r}
round(cor_p$p.value, 3)
```
Напомним, что чем выше уровень значимости, тем с большей уверенностью мы можем заключить, что между переменными нет значимой связи. Таким образом, использование факторов занятости среди молодёжи и занятости в сфере производства в итоговом наборе переменных для регресионного анализа будет весьма иррациональным.

Визаулизируем полученные результаты:
```{r}
res2 <- cor.mtest(clearData, conf.level = 0.95)
corrplot(cor_p$estimate, p.mat = res2$p, sig.level = 0.05)
``` 

Результаты расчетов показывают, что ни один из признаков не имеет значение коэффициента, указывающего на умеренную или сильную связь.

Построим доверительные интервалы для частных коэффициентов корреляции, чтобы в альтернативном виде представить значимость полученных значений. Сначала воспользуемся написанной функцией, приведённой на сайте Stackoverflow:

```{r}
pcor_ci.test <-
function (x, y, z, method = c("pearson", "kendall", "spearman"), conf.level = 0.95, ...) {
    d1 <- deparse(substitute(x))
    d2 <- deparse(substitute(y))
    d3 <- deparse(substitute(z))
    data.name <- paste0(d1, " and ", d2, "; controlling: ", d3)
    method <- match.arg(method)
    Method <- paste0("Partial correlation (", method, ")")
    alternative <- "true partial correlation is not equal to 0"

    x <- as.vector(x)
    y <- as.vector(y)
    z <- as.data.frame(z)
    xyz <- data.frame(x, y, z)
    pcor <- ppcor::pcor(xyz, method = method)
    estimate <- pcor$est[1, 2]
    p.value <- pcor$p.value[1, 2]
    parameter <- c(n = pcor$n, gp = pcor$gp)
    statistic <- c(Stat = pcor$statistic[1, 2])

    fit1 <- lm(x ~ ., data = xyz)
    fit2 <- lm(y ~ ., data = xyz)
    cortest <- cor.test(resid(fit1), resid(fit2), method = method, conf.level = conf.level, ...)
    ci <- cortest$conf.int
    ci
 
}
```
Ввиду сложности реализации данной функции и необходимости углубленно разбираться в основах программирования на языке R, ограничимся лишь доверительными интервалами для частных коэффициентов корреляции объясняющих переменных с одной лишь целевой переменной:
```{r}
drop <- c("Export", "GDP.per.capita....")
pcor_ci.test(clearData$Export, clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
drop <- c("Consumption", "GDP.per.capita....")
pcor_ci.test(clearData$Consumption, clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
drop <- c("Labor.among.youth", "GDP.per.capita....")
pcor_ci.test(clearData$Labor.among.youth, clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
drop <- c("Employment.in.services", "GDP.per.capita....")
pcor_ci.test(clearData$Employment.in.services, clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
drop <- c("Employment.in.industry", "GDP.per.capita....")
pcor_ci.test(clearData$Employment.in.industry, clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
drop <- c("Mortality.rate.under.5", "GDP.per.capita....")
pcor_ci.test(clearData$Mortality.rate.under.5, clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
drop <- c("Population..largest.city.", "GDP.per.capita....")
pcor_ci.test(clearData$Population..largest.city., clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
drop <- c("University.enrollment", "GDP.per.capita....")
pcor_ci.test(clearData$University.enrollment, clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
drop <- c("Unemployment", "GDP.per.capita....")
pcor_ci.test(clearData$Unemployment, clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
drop <- c("Urban.population", "GDP.per.capita....")
pcor_ci.test(clearData$Urban.population, clearData$GDP.per.capita...., clearData[ , !(names(clearData) %in% drop)], method="pearson")
```
Проинтерпретируем полученные результаты: 


Частные коэффициенты корреляции всех переменных модели в абсолютном значении меньше парных коэффициентов. Это говорит о том, что взаимосвязь признаков с ВВП на д.н. в некоторой степени обусловлена воздействием на них фиксируемых факторов. Исключением является только безработица, частный коэффициент корреляции больше парного для данного показателя, то есть остальные признаки ослабляют связь между рассматриваемыми двумя.

Вычислим множественный коэффициент корреляции для нашей целевой переменной, отражающий тесноту связи между результативной переменной и всеми остальными факторами в наборе данных:

```{r}
multiple_r <- lm(GDP.per.capita.... ~ ., clearData)
sqrt(summary(multiple_r)$r.squared)
cor(multiple_r$model$GDP.per.capita...., multiple_r$fitted.values)
```
Благодаря этому значению мы можем сделать вывод о том, что в рамках модели показатель ВВП на душу населения может быть предсказан крайне точно и почти функционально описывается с помощью имеющихся в нашем расположении переменных. Это очень хороший вывод, показывающий наличие действительной пользы для понимания факторов, определяющих значение нашей целевой переменной на основе взятых факторов. Также это означает, что мы выбрали верные предпосылки для данной работы и выделили верные влияющие переменные.

## Регресионный анализ. Линейная регресионная модель

Начнем с элементарного - **двумерная модель линейной регрессии**. Ранее мы провели разведочный анализ данных и применили методы корреляционного анализа для оценки наличия статистических линейных связей между переменными. Также мы провели обработку исходных данных, удалили выбросы и проверили логарифмированные данные на нормальность их распределения. Можем приступить к моделированию показателя ВВП на душу населения.

Возможная гипотеза исследования: ВВП на душу населения тем выше, чем больше доля городского населения.
За долю городского населения отвечает переменная `Urban.population`. Тогда в терминах модели регрессии в пользу тестируемой гипотезы будет говорить отрицательное значение оценки коэффициента при данном регрессоре и ее статистически значимое отличие от нуля.

Двумерная модель линейной регрессии:
```{r}
lm <- lm(GDP.per.capita....~ Urban.population, clearData)
summary(lm)
```

Визуализируем полученную модель:
```{r}
ggscatter(clearData, x = 'Urban.population', y = "GDP.per.capita....", cor.coef = TRUE, size = 2,
          add = "reg.line", add.params = list(color = "pink"), conf.int = TRUE,
          xlab = "Доля городского населения", ylab = "Логарифм ВВП на душу населения")
```


```{r}
lm2 <- lm(GDP.per.capita....~ Employment.in.services, clearData)
summary(lm2)
ggscatter(clearData, x = 'Employment.in.services', y = "GDP.per.capita....", cor.coef = TRUE, size = 2,
          add = "reg.line", add.params = list(color = "pink"), conf.int = TRUE,
          xlab = "Доля занятых в сфере услуг", ylab = "Логарифм ВВП на душу населения")
```

Из графиков построенных двух моделей можно сделать вывод о том, что вторая (включающая влияние фактора - Employment.in.services) лучше первой, описывающей связь ВВП на душу населения и долю городского населения. Также у модели $lm2$ скорректированный коэффициент детерминации больше, чем у модели $lm1$. Что свидетельствует о том, что у лучшей модели больше доля объясненной дисперсии рассматриваемого нами ряда (GDP.per.capita).

Можно построить много двумерных моделей линейной регрессии, но удобнее будет построить графики для оцененных уравнений двумерной регрессии с каждым регрессором в отдельности, указав в качестве аргумента оценку модели с этими регрессорами: 
```{r}
plot_model(lm(formula = GDP.per.capita.... ~ Export + Consumption + Labor.among.youth + Employment.in.services + Employment.in.industry + Mortality.rate.under.5 + Population..largest.city. + University.enrollment + Unemployment + Urban.population, data = clearData), type = 'slope')
```

Таким образом, мы, глядя на график, можем проинтерпретировать взаимосвязь каждой переменной с объясняемой. Так, положительную связь с ВВП на душу населения имеют 5 из 12 рассматриваемых переменных, среди них наиболее эффективными в моделировании показателя ВВП можно считать 3 - долю занятых в сфере услуг, зачисление в университет (взятое нами в качестве оценки уровня образования) и долю городского населения. Отсутствие линейной связи (что уже было видно из части корреляционного анализа) наблюдается с двумя переменными: численность крупнейшего города и уровень безработицы. Из графиков видно, что там имеет место нелинейная зависимость, которая свидетельствует о том, что в наиболее развитых странах уровень безработицы держится на естественном уровне, тогда как в развивающихся странах статистика либо подтасовывается органами, осуществляющими сбор статистики, либо политика полной занятости рабочей силы государством не приводит к стимулированию экономического роста. В случае же доли населения в самом большом городе мы можем справедливо предположить, что маленьким странам по типу Люксмебурга, Сингапура или Сан-Марино, где ограниченная площадь не располагает к тому, чтобы жители стремились находиться где-либо, кроме столицы (в Сингапуре такой возможности физически нет), достаточно легко развиваться в современном мире, не имея необходимости вкладывать в развитие собственного производства и агрокультуры, усиливая вложения в человеческий капитал и создавая необходимую почву для создания привлекательной финансовой системы, ведущей к увеличению денежных потоков в государство. Эти рассуждения будут применены в заключительной части работы. 

Но сейчас необходимо продвинуться в развитии модели линейной регрессии. Поэтому теперь посмотрим линейную модель множественной регрессии со **всеми имеющимися в нашем распоряжении объясняющими переменными**:

```{r}
lm3 <- lm(GDP.per.capita.... ~ .,clearData)
summary(lm3)
```

Найдем доверительные интервалы для всех параметров полученной модели:
```{r}
coefci(lm3)
```

Значимы только Employment.in.services (доля занятых в сфере услуг), Mortality.rate.under.5 (уровень смертности), University.enrollment (количество поступивших в университет), unemployment (уровень безработицы) и Urban.population (доля городского населения). Получили 5 значимых переменных. 

Для удобства визуализируем интервальные оценки
```{r}
plot_model(lm3, ci.lvl = 0.995)
```

Еще один этап валидации результатов - анализ остатков, проверим гипотезу $H_{0}$ о нормальном распределении остатков:
```{r}
res_2 <- lm3$residuals

plot(seq(1, nrow(clearData), 1), res_2, pch = 16, xlab = 'Номер наблюдения', ylab = 'Остатки')
abline(h = mean(res_2), col = 'red', lwd = 2)

hist(res_2, breaks = sqrt(length(res_2)), xlab = 'Остатки', ylab = 'Частота', main = 'Гистограмма распредления частот остатков', col = 'pink')

qqnorm(res_2,pch = 16, xlab = 'Теоретический квантиль', ylab = 'Выборочный квантиль', main = 'Норм график квантиль-квантиль')
qqline(res_2, lwd = 2, col = 'red')
```
Визуально кажется, что остатки действительно распределены нормально и наличиствуется лишь один значительный выброс при прогнозировании логарифма ВВП на душу населения одной из наиболее развитых стран среди оставшихся в выборке.

Проверим нормальность остатков:
```{r}
PearsonTest(res_2)
jb.norm.test(res_2)
```
Результаты тестов показывают достаточно большое значение p-value, что говорит о том, что нулевая гипотеза о принадлежности остатков нормальному закону распределения действительно не отвергается.


```{r}
pred <- predict(lm3)
plot(seq(1, nrow(clearData), 1), clearData$GDP.per.capita...., pch = 16,
     xlab = "Номер наблюдения", ylab = "Логарифм ВВП на душу населения")
lines(seq(1, nrow(clearData), 1), pred, col = "pink", lwd = 2)
```

```{r}
pred_2 <- predict(lm3)

#для доли городского населения
df_true <- data.frame(x = clearData$Urban.population, y = clearData$GDP.per.capita....)
df_true$GDP <- 'фактическая'

df_pred <- data.frame(x = clearData$Urban.population, y = pred_2)
df_pred$GDP <- 'модельная'

df <- rbind.data.frame(df_true,df_pred)
ggplot(df, aes(x = x, y = y)) + 
  geom_point(aes(color = GDP)) + 
  labs(x = 'Доля городского населения', y = 'Логарифм ВВП на душу населения')

#для доли занятых в сфере услуг
df_true_2 <- data.frame(x = clearData$Employment.in.services, y = clearData$GDP.per.capita....)
df_true_2$GDP <- 'фактическая'

df_pred_2 <- data.frame(x = clearData$Employment.in.services, y = pred_2)
df_pred_2$GDP <- 'модельная'

df_2 <- rbind.data.frame(df_true_2,df_pred_2)
ggplot(df_2, aes(x = x, y = y)) + 
  geom_point(aes(color = GDP)) + 
  labs(x = 'Доля занятых в сфере услуг', y = 'Логарифм ВВП на душу населения')

#для поступивших в университет
df_true_3 <- data.frame(x = clearData$University.enrollment, y = clearData$GDP.per.capita....)
df_true_3$GDP <- 'фактическая'

df_pred_3 <- data.frame(x = clearData$University.enrollment, y = pred_2)
df_pred_3$GDP <- 'модельная'

df_3 <- rbind.data.frame(df_true_3,df_pred_3)
ggplot(df_3, aes(x = x, y = y)) + 
  geom_point(aes(color = GDP)) + 
  labs(x = 'Число поступивших в университет', y = 'Логарифм ВВП на душу населения')

#для уровня смертности
df_true_4 <- data.frame(x = clearData$Mortality.rate.under.5, y = clearData$GDP.per.capita....)
df_true_4$GDP <- 'фактическая'

df_pred_4 <- data.frame(x = clearData$Mortality.rate.under.5, y = pred_2)
df_pred_4$GDP <- 'модельная'

df_4 <- rbind.data.frame(df_true_4,df_pred_4)
ggplot(df_4, aes(x = x, y = y)) + 
  geom_point(aes(color = GDP)) + 
  labs(x = 'Уровень смертности', y = 'Логарифм ВВП на душу населения')

```

В целом большинство точек совпадают или же находятся примерно в одной области, то есть модельные значение исследуемого показателя совпадают с реальными, можно сделать вывод о хорошей предсказательной способности модели.

Попробуем построить модель, включив только те значимые переменные, в линейности которых мы уверены
```{r}
lm4 <- lm(GDP.per.capita.... ~ clearData$Export + clearData$Consumption + clearData$Labor.among.youth + clearData$Employment.in.services + clearData$Employment.in.industry + clearData$Mortality.rate.under.5 + clearData$University.enrollment + clearData$Urban.population, clearData)
summary(lm4)
```
Как ни странно, скорректированное значение R^2 несколько уменьшилось.

Сравним построенные линейные модели с помощью функции AIC.
```{r}
AIC(lm)
AIC(lm2)
AIC(lm3)
AIC(lm4)
```
Таким образом, уравнение лучшей линейной модели выглядит следующим образом:
$Y=7,939+0,003x_{1}-0,007x_{2}-0,012x_{3}-0,001x_{4}+0,032x_{5}-0,001x_{6}-0,0072x_{7}-0,005x_{8}+0,012x_{9}-0,024x_{10}+0,011x_{11}$, 
где $x_{1} - Export, x_{2} - Consumption, x_{3} - National.Expanditure, x_{4} - Labor.among.youth, x_{5}-Employment.in.services, x_{6}-Employment.in.industry, x_{7}-Mortality.rate.under.5, x_{8}- Population..largest.city., x_{9}-University.enrollment, x_{10}-Unemployment, x_{11} - Urban.population$

### Регресионная модель, основанная только на значимых переменных

Иногда бывает так, что результаты применения статистических тестов, в частности t-тестов на значимость отдельных коэффициентов, зависят от набора регрессоров - это одно из возможных последствий проблемы мультиколлинеарности, когда присутствует довольно сильная линейная связь между регрессорами. Прямо сейчас мы попробуем самый простой способ преодоления этой проблемы - пересмотр набора регрессоров. В прикладной статистике и машинном обучении распространенным способом отбора регрессоров является метод включения и метод исключения.

Идея состоит в следующем: при методе включения сначала строится модель с одним регрессором, для которого парный коэффициент корреляции с зависимой переменной является наибольшим по модулю. Далее добавляется следующий по тесноте линейной связи регрессор, и так до тех пор пока коэффициент при добавленном регрессоре не окажется незначимым.

```{r}
regfit_fwd <- regsubsets(GDP.per.capita....~., clearData, force.in = c(6,7,8), intercept = TRUE, method = 'forward')
summary(regfit_fwd)

```

Так как модели с разным числом регрессоров - сравниваем по скорректированному R2 (сравниваем качество моделей при прочих равных, то есть условно уравниваем количество регрессоров):
```{r}
summary(regfit_fwd)$adjr
```

```{r}
regfit_bwd <- regsubsets(GDP.per.capita.... ~., clearData, force.in = c(6,7,8), intercept = TRUE, method = 'backward')
summary(regfit_bwd)
summary(regfit_bwd)$adjr
```

```{r}
res.sum <- summary(regfit_fwd)
data.frame(
  Adj.R2 = which.max(res.sum$adjr2),
  CP = which.min(res.sum$cp),
  BIC = which.min(res.sum$bic)
)
```
Здесь скорректированный R2 говорит нам, что лучшая модель-это та, в которой есть 6 переменных-предикторов. Однако, используя критерии BIC и Cp, мы должны перейти к модели с 5 и 4 переменными, соответственно (нужные в каждом случае переменные отмечены *).

Итак, построим три новые модели и найдем лучшую как-нибудь по-другому.

```{r}
lm_with_6 <- lm(GDP.per.capita.... ~ clearData$Export + clearData$Employment.in.services + clearData$Employment.in.industry + clearData$Mortality.rate.under.5 + clearData$University.enrollment + clearData$Urban.population, clearData)
lm_with_5 <- lm(GDP.per.capita.... ~ clearData$Export + clearData$Employment.in.services + clearData$Employment.in.industry + clearData$Mortality.rate.under.5 + clearData$University.enrollment, clearData)
lm_with_4 <- lm(GDP.per.capita.... ~ clearData$Export + clearData$Employment.in.services +clearData$Employment.in.industry + clearData$Mortality.rate.under.5, clearData)

summary(lm_with_6)
summary(lm_with_5)
summary(lm_with_4)
```
Выявим лучшую модель:
```{r}
AIC(lm_with_4)
AIC(lm_with_5)
AIC(lm_with_6)

BIC(lm_with_4)
BIC(lm_with_5)
BIC(lm_with_6)
```
Получаем, что оптимальной является модель с 6 переменными (lm_with_6). Уравнение данной линейной регрессии имеет вид:

$\ln{Y}=8,103-0,02x_{1}+0,027x_{2}+0,004x_{3}-0,008x_{4}+0,013x_{5}+0,011x_{6}$

где $x_{1}-National.Expanditure, x_{2}-Employment.in.services, x_{3}-Employment.in.industry, x_{4}-Mortality.rate.under.5, x_{5}-University.enrollment, x_{6}-Urban.population$

В целом, среди всех линейных моделей, наиболее качественной по показателю скорректированного $R^2$ оказалась именно модель со всеми оставшимися для анализа переменными, давшую результат 0,875. Это очень хорошая предсказательная сила, однако попробуем улучшить её, применив нелинейность к двум признакам, двумерная модель регрессии для которой показалась наименее линейной.

## Регресионный анализ. Нелинейная (степенная) регресионная модель

Попробуем с помощью Desmos подогнать примерные выходы модели в зависимости от значений показателя безработицы и населения в наибольшем городе:
```{r}
nlm_clearData <- clearData
nlm_clearData$Population..largest.city. <- log(nlm_clearData$Population..largest.city.^2-5*nlm_clearData$Population..largest.city.+40)
nlm_clearData$Unemployment <- (nlm_clearData$Unemployment^2)/((nlm_clearData$Unemployment-4)^2+5)
nlm1 <- lm(GDP.per.capita.... ~ ., nlm_clearData)
summary(nlm1)
```
```{r}
plot_model(lm(formula = GDP.per.capita.... ~ Population..largest.city.  + Unemployment, data = nlm_clearData), type = 'slope')
```

Видим, что несмотря на то, что поведение графика объясняющих переменных теперь хорошо описывает зависимость с логарифмом ВВП на душу населения, но при этом скорректированный $R^2$ лишь уменьшился, тогда как показатель AIC увеличился, что кажется для нас несколько странным. 

Попробуем прологарифмировать все имеющиеся объясняющие переменные, чтобы привести все данные к одному виду. Возможно, это улучшит выходы нашей модели:
```{r}
nlm_clearData <- clearData
nlm_clearData$Population..largest.city. <- log(nlm_clearData$Population..largest.city.)
nlm_clearData$Unemployment <- log(nlm_clearData$Unemployment)
nlm_clearData$Export <- log(nlm_clearData$Export)
nlm_clearData$Consumption <- log(nlm_clearData$Consumption)
nlm_clearData$Labor.among.youth <- log(nlm_clearData$Labor.among.youth)
nlm_clearData$Employment.in.services <- log(nlm_clearData$Employment.in.services)
nlm_clearData$Employment.in.industry <- log(nlm_clearData$Employment.in.industry)
nlm_clearData$Mortality.rate.under.5 <- log(nlm_clearData$Mortality.rate.under.5)
nlm_clearData$University.enrollment <- log(nlm_clearData$University.enrollment)
nlm_clearData$Urban.population <- log(nlm_clearData$Urban.population)
nlm2 <- lm(GDP.per.capita.... ~ ., nlm_clearData)
summary(nlm2)
```

```{r}
nlm_clearData <- clearData
nlm_clearData$Population..largest.city. <- log(nlm_clearData$Population..largest.city.)
nlm_clearData$Unemployment <- log(nlm_clearData$Unemployment)
nlm_clearData$Export <- log(nlm_clearData$Export)
nlm_clearData$Labor.among.youth <- log(nlm_clearData$Labor.among.youth)
nlm_clearData$Employment.in.services <- nlm_clearData$Employment.in.services
nlm_clearData$Employment.in.industry <- log(nlm_clearData$Employment.in.industry)
nlm_clearData$Mortality.rate.under.5 <- log(nlm_clearData$Mortality.rate.under.5)
nlm_clearData$University.enrollment <- log(nlm_clearData$University.enrollment)
nlm_clearData$Urban.population <- log(nlm_clearData$Urban.population)
nlm3 <- lm(GDP.per.capita.... ~ ., nlm_clearData)
summary(nlm3)
```
```{r}
plot_model(lm(formula = GDP.per.capita.... ~ Export + Consumption + Labor.among.youth + Employment.in.services + Employment.in.industry + Mortality.rate.under.5 + Population..largest.city. + University.enrollment + Unemployment + Urban.population, data = nlm_clearData), type = 'slope')
```
```{r}
AIC(lm3)
AIC(nlm1)
AIC(nlm2)
AIC(nlm3)
```
Сравнивая с лучшей линейной моделью, мы видим, что стандартная ошибка остатков лучшей нелинейной модели, в которой прологарифмированы все переменные, кроме доли населения, занятой в сфере услуг, уменьшилась на 0.051 и скорректированный $R^2$ увеличился на 0.026, что является достаточно прорывным результатом, показывающим эффективность проведённых преобразований. 

Перед публикацией наиболее оптимальной модели для нашей задачи, проверим её на ряд формальностей. "Нормальны" ли остатки?
```{r}
res_2 <- nlm3$residuals

plot(seq(1, nrow(clearData), 1), res_2, pch = 16, xlab = 'Номер наблюдения', ylab = 'Остатки')
abline(h = mean(res_2), col = 'red', lwd = 2)

hist(res_2, breaks = sqrt(length(res_2)), xlab = 'Остатки', ylab = 'Частота', main = 'Гистограмма распредления частот остатков', col = 'pink')

qqnorm(res_2,pch = 16, xlab = 'Теоретический квантиль', ylab = 'Выборочный квантиль', main = 'Норм график квантиль-квантиль')
qqline(res_2, lwd = 2, col = 'red')
```
Визуально кажется, что остатки действительно распределены нормально и есть лишь один значительный выброс при прогнозировании логарифма ВВП на душу населения одной из наиболее развитых стран среди оставшихся в выборке.

Проверим нормальность остатков:
```{r}
PearsonTest(res_2)
jb.norm.test(res_2)
```
Результаты тестов говорят о том, что нулевая гипотеза о принадлежности остатков нормальному закону распределения действительно не отвергается на уровне значимости 0,001. Это не очень хорошо, но приемлемо.


```{r}
pred <- predict(nlm3)
plot(seq(1, nrow(clearData), 1), clearData$GDP.per.capita...., pch = 16,
     xlab = "Номер наблюдения", ylab = "Логарифм ВВП на душу населения")
lines(seq(1, nrow(clearData), 1), pred, col = "pink", lwd = 2)
```

```{r}
pred_2 <- predict(nlm3)

#для доли городского населения
df_true <- data.frame(x = clearData$Urban.population, y = clearData$GDP.per.capita....)
df_true$GDP <- 'фактическая'

df_pred <- data.frame(x = clearData$Urban.population, y = pred_2)
df_pred$GDP <- 'модельная'

df <- rbind.data.frame(df_true,df_pred)
ggplot(df, aes(x = x, y = y)) + 
  geom_point(aes(color = GDP)) + 
  labs(x = 'Доля городского населения', y = 'Логарифм ВВП на душу населения')

#для доли занятых в сфере услуг
df_true_2 <- data.frame(x = clearData$Employment.in.services, y = clearData$GDP.per.capita....)
df_true_2$GDP <- 'фактическая'

df_pred_2 <- data.frame(x = clearData$Employment.in.services, y = pred_2)
df_pred_2$GDP <- 'модельная'

df_2 <- rbind.data.frame(df_true_2,df_pred_2)
ggplot(df_2, aes(x = x, y = y)) + 
  geom_point(aes(color = GDP)) + 
  labs(x = 'Доля занятых в сфере услуг', y = 'Логарифм ВВП на душу населения')

#для поступивших в университет
df_true_3 <- data.frame(x = clearData$University.enrollment, y = clearData$GDP.per.capita....)
df_true_3$GDP <- 'фактическая'

df_pred_3 <- data.frame(x = clearData$University.enrollment, y = pred_2)
df_pred_3$GDP <- 'модельная'

df_3 <- rbind.data.frame(df_true_3,df_pred_3)
ggplot(df_3, aes(x = x, y = y)) + 
  geom_point(aes(color = GDP)) + 
  labs(x = 'Число поступивших в университет', y = 'Логарифм ВВП на душу населения')

#для уровня смертности
df_true_4 <- data.frame(x = clearData$Mortality.rate.under.5, y = clearData$GDP.per.capita....)
df_true_4$GDP <- 'фактическая'

df_pred_4 <- data.frame(x = clearData$Mortality.rate.under.5, y = pred_2)
df_pred_4$GDP <- 'модельная'

df_4 <- rbind.data.frame(df_true_4,df_pred_4)
ggplot(df_4, aes(x = x, y = y)) + 
  geom_point(aes(color = GDP)) + 
  labs(x = 'Уровень смертности', y = 'Логарифм ВВП на душу населения')

```

Теперь мы можем заключить, что наша наиболее оптимальная модель принимает следующий вид:

$\ln{Y}=13.473+0,04\ln{x_{1}}-1,398x_{2}-0,129\ln{x_{3}}+0,028x_{4}-0,23\ln{x_{5}}-0,562\ln{x_{6}}-0.071\ln{x_{7}}+0,049\ln{x_{8}}-0,176\ln{x_{9}}+0.671\ln{x_{10}}$

где $x_{1}-Export, x_{2}-Consumption, x_{3}-Labor.among.youth, x_{4}-Employment.in.services, x_{5}-Employment.in.industry, x_{6}-Mortality.rate.under.5, x_{7}-Population..largest.city, x_{8}-University.enrollment, x_{9}-Unemployment, x_{10}-Urban.population$

## Выводы по итогам проведённой работы

Увеличение благосостояния общества, выражаемое в виде ВВП на душу населения по номиналу в долларах, становится возможным, если мы обеспечим равномерное и стойкое развитие инфраструктуры городов, стимулируя граждан заселяться не только в наиболее крупном городе, но и в других городах. 
Также крайне важно улучшать качество медицины, поскольку это является ключом к сохранению человеческого капитала государства, дающее возможность людям легко пережить любые болезни и сократит детскую смертность, которая впоследствии выльется в будущем развитии государства. 
Сокращение потребления населения, вызванное увеличением сбережений, является также позитивным индикатором для развития экономики страны ввиду того, что возможность сберегать в принципе отражает то, что не все доходы населения идут на сиюсекундное потребление, поэтому развитие стимулов к увеличению сбережений является весьма важной задачей государства для увеличения благосостояния её горожан.
Уменьшение доли занятых в производстве и соответственное увеличение доли занятых в сфере услуг также является очень важной задачей, которую можно достичь через увеличение субсидий, направленных на автоматизацию производства и открытие малых и средних бизнесов, не связанных с ручным трудом.
Также очевидно, что создание рабочих мест и сокращение безработицы является позитивным фактором для благосостояния горожан.

Особенно примечательно, что столь важные взаимосвязи стали прослеживаться после логарифмирования почти всех переменных, что можно интерпретировать математически. Убывающая отдача от масштаба объясняющих переменных, описываемая функцией логарифма, свидетельствует о критической важности начальных стадий развития указанных факторов. Например, если в государстве почти нет городов и большинство людей проживают в мелких поселениях без доступа к широкой информации, развитие инфраструктуры до уровня городов существенно раскроет интеллектуальный потенциал близлежащего населения и поспособствует развитию страны в целом. Однако если государство уже достаточно развито, вряд ли будет какой-либо толк пытаться увеличить долю городского населения с 96% до 97%. 

Вывод касательно потребления и сбережений кажется несколько неверным ввиду того, что вероятнее всего, на деле причино-следственная связь работает наоборот: если граждане живут достаточно благополучно, то они могут позволить себе не только выживать, проживая "от зарплаты до зарплаты", но и откладывать на будущие большие приобретения по типу квартиры, машины или чего-то подобного. Поэтому в заключение представим ещё одну модель, в которой не рассматривается потребление:

```{r}
drop <- c("Consumption")
nlm_clearData <- clearData[ , !(names(clearData) %in% drop)]
nlm_clearData$Population..largest.city. <- log(nlm_clearData$Population..largest.city.)
nlm_clearData$Unemployment <- log(nlm_clearData$Unemployment)
nlm_clearData$Export <- log(nlm_clearData$Export)
nlm_clearData$Labor.among.youth <- log(nlm_clearData$Labor.among.youth)
nlm_clearData$Employment.in.services <- nlm_clearData$Employment.in.services
nlm_clearData$Employment.in.industry <- log(nlm_clearData$Employment.in.industry)
nlm_clearData$Mortality.rate.under.5 <- log(nlm_clearData$Mortality.rate.under.5)
nlm_clearData$University.enrollment <- log(nlm_clearData$University.enrollment)
nlm_clearData$Urban.population <- log(nlm_clearData$Urban.population)
nlm5 <- lm(GDP.per.capita.... ~ ., nlm_clearData)
summary(nlm5)
```
Видим, что в этой модели значение $R^2$ находится примерно на уровне линейной модели, что всё ещё достаточно хороший результат, но на этот раз ещё и избавленный от логических несостыковок. 

На этом наш анализ по итогам компьютерной работы №1 следует считать завершённым.